services:
  moltbot-local:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        CLAWDBOT_GIT_REF: main
    container_name: moltbot-local
    restart: unless-stopped

    # Podman precisa de privileged para NET_ADMIN + /dev/net/tun funcionar corretamente
    privileged: true
    
    cap_add:
      - NET_ADMIN
      - NET_RAW

    devices:
      - /dev/net/tun:/dev/net/tun

    ports:
      - "8080:8080"
      - "18789:18789"

    volumes:
      - ./dev-workspace:/data/workspace
      - clawd-data:/data/.clawdbot
      - clawd-root:/root/clawd
      
    environment:
      # REQUIRED
      SKIP_ONBOARD: ${SKIP_ONBOARD:1}
      SETUP_PASSWORD: ${SETUP_PASSWORD}
      CLAWDBOT_STATE_DIR: ${CLAWDBOT_STATE_DIR}
      CLAWDBOT_WORKSPACE_DIR: ${CLAWDBOT_WORKSPACE_DIR}
      CLAWDBOT_CONFIG_PATH: ${CLAWDBOT_CONFIG_PATH}
      
      # RECOMMENDED
      CLAWDBOT_GATEWAY_TOKEN: ${CLAWDBOT_GATEWAY_TOKEN}

      # OPTIONAL
      PORT: ${PORT:8080}
      INTERNAL_GATEWAY_PORT: ${INTERNAL_GATEWAY_PORT:18789}
      INTERNAL_GATEWAY_HOST: ${INTERNAL_GATEWAY_HOST:127.0.0.1}
      CLAWDBOT_ENTRY: ${CLAWDBOT_NODE:/clawdbot/dist/entry.js} 
      CLAWDBOT_NODE: ${CLAWDBOT_NODE:node}
      
      # TAILSCALE (opcional - descomente e configure para usar)
      TAILSCALE_AUTHKEY: ${TAILSCALE_AUTHKEY:-}
      TAILSCALE_HOSTNAME: ${TAILSCALE_HOSTNAME:moltbot-local}
      TAILSCALE_EXTRA_ARGS: ${TAILSCALE_EXTRA_ARGS:-}
      TAILSCALE_EXIT_NODE: ${TAILSCALE_EXIT_NODE:-}

    sysctls:
      net.ipv4.ip_forward: "1"
      net.ipv6.conf.all.forwarding: "1"

volumes:
  clawd-data:
    external: true
  clawd-root:
    external: true
